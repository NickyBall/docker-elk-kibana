# Add this to your existing nginx configuration
# This listens on port 9200 and proxies to private Elasticsearch cluster
#
# Installation:
#   sudo cp elasticsearch-proxy-addon.conf /etc/nginx/sites-available/elasticsearch-proxy
#   sudo ln -s /etc/nginx/sites-available/elasticsearch-proxy /etc/nginx/sites-enabled/
#   sudo nginx -t
#   sudo systemctl reload nginx

# Upstream for load balancing between private ES nodes
upstream elasticsearch_backend {
    server PRIVATE_ES_NODE1_IP:9200 max_fails=3 fail_timeout=30s;
    server PRIVATE_ES_NODE2_IP:9200 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# Listen on port 9200 and proxy to private Elasticsearch
server {
    listen 9200;

    # Optional: only allow specific IPs
    # allow YOUR_LAPTOP_IP;
    # deny all;

    location / {
        proxy_pass http://elasticsearch_backend;

        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Timeouts for large requests
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Allow large request bodies for bulk indexing
        client_max_body_size 100M;
    }
}
